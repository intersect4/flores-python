<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo de Sensores</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Panel de Monitoreo</h1>
            <p class="text-gray-600">Sistema de Monitoreo de Sensores en Tiempo Real</p>
        </div>

        <div class="grid grid-cols-1 gap-8">
            <!-- Panel de Control -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <form class="grid grid-cols-1 md:grid-cols-4 gap-4" method="GET" action="/">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Sensor:</label>
                        <select id="sensorSelect" name="device_id" class="w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5">
                            {% for sensor in sensors %}
                                <option value="{{ sensor }}" {% if sensor == selected_sensor %}selected{% endif %}>{{ sensor }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Fecha Inicio:</label>
                        <input type="date" name="start_date" value="{{ start_date }}" class="w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Fecha Fin:</label>
                        <input type="date" name="end_date" value="{{ end_date }}" class="w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5">
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2.5 px-4 rounded-lg transition-colors">
                            Actualizar Datos
                        </button>
                    </div>
                </form>
            </div>

            <!-- Valores Actuales -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Temperatura</h3>
                    <p class="text-3xl font-bold text-blue-600" id="temp-actual">--°C</p>
                    <p class="text-sm text-gray-500 mt-2">Última lectura</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Nivel de Luz</h3>
                    <p class="text-3xl font-bold text-yellow-600" id="luz-actual">-- lux</p>
                    <p class="text-sm text-gray-500 mt-2">Última lectura</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Humedad</h3>
                    <p class="text-3xl font-bold text-green-600" id="hum-actual">--%</p>
                    <p class="text-sm text-gray-500 mt-2">Última lectura</p>
                </div>
            </div>

            {% if fecha_80 %}
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                            Según la tendencia actual, la intensidad de luz caerá por debajo del 80% aproximadamente el 
                            <strong>{{ fecha_80.strftime('%d/%m/%Y') }}</strong>
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Gráficas -->
            <div class="space-y-6">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div id="temp-plot" class="w-full h-[400px]"></div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div id="luz-plot" class="w-full h-[400px]"></div>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div id="hum-plot" class="w-full h-[400px]"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuración inicial de las gráficas
        const graphs_temp = {{ plot_temp | safe }};
        const graphs_luz = {{ plot_luz | safe }};
        const graphs_hum = {{ plot_hum | safe }};
        
        const commonConfig = {
            responsive: true,
            displayModeBar: false
        };

        // Personalización de temas para cada gráfica
        graphs_temp.layout.paper_bgcolor = 'rgba(0,0,0,0)';
        graphs_temp.layout.plot_bgcolor = 'rgba(0,0,0,0)';
        graphs_temp.layout.margin = { t: 30, r: 20, b: 40, l: 50 };
        graphs_temp.layout.font = { family: 'Arial, sans-serif' };
        graphs_temp.data[0].line = { color: '#2563eb', width: 2 };

        graphs_luz.layout.paper_bgcolor = 'rgba(0,0,0,0)';
        graphs_luz.layout.plot_bgcolor = 'rgba(0,0,0,0)';
        graphs_luz.layout.margin = { t: 30, r: 20, b: 40, l: 50 };
        graphs_luz.layout.font = { family: 'Arial, sans-serif' };

        graphs_hum.layout.paper_bgcolor = 'rgba(0,0,0,0)';
        graphs_hum.layout.plot_bgcolor = 'rgba(0,0,0,0)';
        graphs_hum.layout.margin = { t: 30, r: 20, b: 40, l: 50 };
        graphs_hum.layout.font = { family: 'Arial, sans-serif' };
        graphs_hum.data[0].line = { color: '#16a34a', width: 2 };

        Plotly.newPlot('temp-plot', graphs_temp.data, graphs_temp.layout, commonConfig);
        Plotly.newPlot('luz-plot', graphs_luz.data, graphs_luz.layout, commonConfig);
        Plotly.newPlot('hum-plot', graphs_hum.data, graphs_hum.layout, commonConfig);

        // Actualizar valores actuales
        if (graphs_temp.data[0].y.length > 0) {
            document.getElementById('temp-actual').textContent = 
                graphs_temp.data[0].y[graphs_temp.data[0].y.length - 1].toFixed(1) + '°C';
        }
        if (graphs_luz.data[0].y.length > 0) {
            document.getElementById('luz-actual').textContent = 
                graphs_luz.data[0].y[graphs_luz.data[0].y.length - 1].toFixed(0) + ' lux';
        }
        if (graphs_hum.data[0].y.length > 0) {
            document.getElementById('hum-actual').textContent = 
                graphs_hum.data[0].y[graphs_hum.data[0].y.length - 1].toFixed(1) + '%';
        }

    </script>
</body>
</html> 